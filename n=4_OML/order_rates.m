% This function takes rates w_ij for n=4 and permutes the indices so that the 
% input rates J_k are ordered J_1 >= ... >= J_4. The input rate is defined to 
% be J_k = sum w(i1,j1)w(i2,j2)w(i3,j3) where the edges (i,j) form a tree on
% the four vertices, with root k. The sum is done over all such trees.

function [w, Jvec, I] = order_rates(w);

% Calculate input rates

J1 = 	w(1,2)*w(1,3)*w(1,4) + w(1,2)*w(2,3)*w(3,4) + w(1,2)*w(2,4)*w(4,3) + ...
	w(1,3)*w(3,2)*w(2,4) + w(1,3)*w(3,4)*w(4,2) + w(1,4)*w(4,3)*w(3,2) + ...
	w(1,4)*w(4,2)*w(2,3) + w(1,2)*w(1,3)*w(2,4) + w(1,2)*w(1,3)*w(3,4) + ...
	w(1,2)*w(1,4)*w(2,3) + w(1,2)*w(1,4)*w(4,3) + w(1,3)*w(1,4)*w(3,2) + ...
	w(1,3)*w(1,4)*w(4,2) + w(1,2)*w(2,3)*w(2,4) + w(1,3)*w(3,2)*w(3,4) + ...
	w(1,4)*w(4,3)*w(4,2);
J2 = 	w(2,1)*w(2,3)*w(2,4) + w(2,1)*w(1,3)*w(3,4) + w(2,1)*w(1,4)*w(4,3) + ...
	w(2,3)*w(3,1)*w(1,4) + w(2,3)*w(3,4)*w(4,1) + w(2,4)*w(4,3)*w(3,1) + ...
	w(2,4)*w(4,1)*w(1,3) + w(2,1)*w(2,3)*w(1,4) + w(2,1)*w(2,3)*w(3,4) + ...
	w(2,1)*w(2,4)*w(1,3) + w(2,1)*w(2,4)*w(4,3) + w(2,3)*w(2,4)*w(3,1) + ...
	w(2,3)*w(2,4)*w(4,1) + w(2,1)*w(1,3)*w(1,4) + w(2,3)*w(3,1)*w(3,4) + ...
	w(2,4)*w(4,3)*w(4,1);
J3 = 	w(3,1)*w(3,2)*w(3,4) + w(3,1)*w(1,2)*w(2,4) + w(3,1)*w(1,4)*w(4,2) + ...
	w(3,2)*w(2,1)*w(1,4) + w(3,2)*w(2,4)*w(4,1) + w(3,4)*w(4,2)*w(2,1) + ...
	w(3,4)*w(4,1)*w(1,2) + w(3,1)*w(3,2)*w(1,4) + w(3,1)*w(3,2)*w(2,4) + ...
	w(3,1)*w(3,4)*w(1,2) + w(3,1)*w(3,4)*w(4,2) + w(3,2)*w(3,4)*w(2,1) + ...
	w(3,2)*w(3,4)*w(4,1) + w(3,1)*w(1,2)*w(1,4) + w(3,2)*w(2,1)*w(2,4) + ...
	w(3,4)*w(4,2)*w(4,1);
J4 = 	w(4,1)*w(4,2)*w(4,3) + w(4,1)*w(1,2)*w(2,3) + w(4,1)*w(1,3)*w(3,2) + ...
	w(4,2)*w(2,1)*w(1,3) + w(4,2)*w(2,3)*w(3,1) + w(4,3)*w(3,2)*w(2,1) + ...
	w(4,3)*w(3,1)*w(1,2) + w(4,1)*w(4,2)*w(1,3) + w(4,1)*w(4,2)*w(2,3) + ...
	w(4,1)*w(4,3)*w(1,2) + w(4,1)*w(4,3)*w(3,2) + w(4,2)*w(4,3)*w(2,1) + ...
	w(4,2)*w(4,3)*w(3,1) + w(4,1)*w(1,2)*w(1,3) + w(4,2)*w(2,1)*w(2,3) + ...
	w(4,3)*w(3,2)*w(3,1);
Jvec = [J1,J2,J3,J4];
I = [1,2,3,4];

% Check to see that the system is non-degenerate

if J1 + J2 + J3 + J4 == 0
    	error('degenerate A')

% Check to see that the input rates are ordered

elseif J4 > J3 || J3 > J2 || J2 > J1

	% Re-order

	holding = w;

	[Jvec,I] = sort([J1,J2,J3,J4],'descend');
  perm = eye(4)(:,I);
  w = perm'*w*perm;
  
end

